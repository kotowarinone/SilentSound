
無再生なだけでコンパクトホームオーディオがすぐにOFFに落ちる問題をどうにか解決したコードと、アナログ的解決をしたのは私が時代遅れのオッサンであることと無関係であることを言い訳するレポジトリ

できるだけ、危険なポイントは示すようにしていますが、基本的に自己責任でご利用ください。

# 背景と問題

KENWOOD社の XK-330 をPCの音声出力に使うために購入しました。

しばらく使用していたのですが、一定時間するとオートパワーオフになったり BTデバイスとしてのXK-330 が切断されてしまう問題が生じました。
PCスピーカーとして用いるにはこの問題はかなり厳しいため、解決が必要でした。


# 問題の解決法

下記２つの対処を同時に行うことで問題がなくなりました。

<pre>
対処A. 3.5mmピンのオーディオケーブルを用いて、アナログで PC のライン出力と XK-330 のライン入力を接続しました。
対処B. PCから1分おきに1秒間、ほぼ無音に近い小さな音を再生し続けました。
</pre>

本プログラムは、上記の 対処B を実現するためのプログラムです。


# 対処B の機能の実現方法

- このプログラムをビルドして SilentSound.exe を Release モードで出力してください。
- パラメータに wav ファイルを指定して SilentSound.exe を実行してください。1分間隔で SilentSound.exe  を再生します。
- 詳細は Program.cs に情報があります。
  - サプライリスクを低減しましょう。

## 添付音声について

再生させる音声データとして、我が家で使っている `SilentSound.wav` も添付しています。この特徴や作り方は後述しております。
このファイルを用いてもうまく切断抑制できない場合には、後述の手段等を用いて音声ファイルを自作して試行錯誤することでも解決するかもしれません。

## タスクマネージャへの登録方法

このプログラムを実行することで音声機器のオートパワーオフ機能が抑制されることを確認出来て、このプログラムを常用したい場合は常時実行するようにしましょう。

1. 上記 exe ファイルと wav ファイルを Program Files などのフォルダの下に配置して、高権限者のみ書き込みできるようにします。
  - 常用するのであれば、常用権限でバイナリをポイズニングされないようにしましょう。。
2. Windowsの検索機能で タスクマネージャを見つけて実行します。
3. タスクの作成 を行います。実行コードとパラメータを指定します。
4. トリガーとしてスタートアップ時やログイン時などを指定します。
5. 複数回起動を指示しても 1インスタンスにするため、設定タブの「新しいインスタンスを生成しない」にします。
6. 終了を行わないように設定しましょう。


# 上記の解決策以外の方策などに関する技術メモ

## なぜ 対処A のアナログ接続が必要なのか
上記 対処A については、Bluetooth 接続で自動切断を抑制したり 自動接続するようにできればよいのですし、それが可能な音響機器もあるのでしょうが、XK-330は下記を行っても自動接続されず、オートパワーオフは行われました。

- BTホストの自動OFFを取り除いた
- BTデバイス（XK-330）の自動 OFFを Windows OS 側で制御できなかった
- Windows側の「BT Support Service」を稼働させてもオートパワーオフした
- オートパワーオフした XK-330 を再度電源投入しても自動接続されなかった
- XK-330には、オートパワーオフという名の機能はないが、Sleep Off は設定できる。ただしそれを行っても無音時の不意な停止を抑制できなかった

なお、上記の Windows および XK-330 の操作は下記となります。
```
- WindowsでのBluetooth制御
  - BT アダプタ（ホスト）で「電源の管理」タブで「電力の節約のために、コンピューターがこのデバイスの電源をオフにできるようにする」→オフにする
  - BT 子デバイスで「電源の管理」タブで「電力の節約のために、コンピューターがこのデバイスの電源をオフにできるようにする」→オフにする
    - XK-330 はこの「電源の管理」タブがありませんでした。 
  - Windowsサービスで、「Bluetooth Support Service」を常時動作させる
    - Win + R → services.msc と入力し Enter／「Bluetooth Support Service」のプロパティを開く／サービスを自動起動させるようにする。
- XK-330でのスリープ抑制
  - 「Sleep OFF」と表示されるまで、リモコンの「スリープ」ボタンを繰り返し押す。
```

## なぜ 対処B の Keep Alive 音声（ダミー音声）が効果があると判断したのか・音声の作成法

Keep Alive 音声を用いた理由
- 上記の検証も含めた これまでの利用において、音声が流れている最中にいきなりスリープしたり電源がOFFになる事態は全く発生していなかったため

なお、お使いの環境で、`SilentSound.wav` の音量が小さすぎて効果がないなどの問題があれば、ご自身でファイルを作成しなおすことをお勧めします。私が用いた作成方法は下記です。
- ChatGPT にお願いして、400Hz 1秒の wavファイルを作成してもらう
- そのファイルを Audacity に読み込ませ、前後に0.1秒のフェードインとフェードアウトを入れて、-65dB の増幅エフェクトをかけた（小さい音にした）
- そのファイルをwav形式でエクスポートした

音量の制御は試行錯誤が必要でかつ数値による微調整が適しているので 生成AIではなく 従来型ツールを用いました。


